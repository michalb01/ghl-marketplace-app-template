<!DOCTYPE html>
<html lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width,initial-scale=1.0">
        <title>Payment</title>
    </head>
    <body>

        <noscript>
            <strong>We're sorry but this page doesn't work properly without JavaScript enabled. Please enable it to continue.</strong>
        </noscript>
        <script>
            window.addEventListener('message', function(event) {
                var data = JSON.parse(event.data);

                if (data.type === 'payment_initiate_props') {
                    console.log('Received payment initiation props:', data);
                }

                var client_data = data.publishableKey;
                const splited_client_data = client_data.split("/");
                var client_id = splited_client_data[0];
                var client_secret = splited_client_data[1];

                var params = `grant_type=client_credentials&client_id=${client_id}&client_secret=${client_secret}`;
                var xhr = new XMLHttpRequest();
                xhr.onreadystatechange = () => {
                    if (xhr.readyState === 4) {
                        var resp = xhr.response;
                        console.log(resp);

                        var access_token = resp.access_token;

                        var ip = fetch('https://api.ipify.org?format=json')
                            .then(response => response.json())
                            .then(data => {
                                console.log(data.ip);
                            })
                            .catch(error => {
                                console.log('Error:', error);
                            });
                        console.log(`IP: ${ip}`);

                        var xhr2 = new XMLHttpRequest();
                        var params2 = JSON.stringify({
                            customerIp: ip,
                            merchantPosId: client_id,
                            description: `${data.contact.name} ${data.transactionId}`,
                            currencyCode: `${data.currency.toUpperCase()}`,
                            totalAmount: data.amount * 100,
                            products: [
                                {
                                    name: `${data.transactionId}`,
                                    unitPrice: data.amount * 100,
                                    quantity: 1
                                }
                            ]
                        });
                        xhr2.open("POST", `https://secure.snd.payu.com/api/v2_1/orders`, true);
                        xhr2.setRequestHeader("Content-type", "application/json");
                        xhr2.setRequestHeader("Authorization", `Bearer ${access_token}`);
                        xhr2.setRequestHeader("Access-Control-Allow-Origin", "*");
                        xhr2.send(params2);
                    }
                };
                xhr.open("POST", `https://secure.snd.payu.com/pl/standard/user/oauth/authorize`, true);
                xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                xhr2.setRequestHeader("Access-Control-Allow-Origin", "*");
                xhr.send(params);
            }, false);

            function onWindowLoad() {
                window.parent.postMessage(JSON.stringify({
                    type: 'custom_provider_ready',
                    loaded: true
                }), '*');

                console.log("custom_provider_ready post sent!")
            }

            window.onload = onWindowLoad;
        </script>
    </body>
</html>